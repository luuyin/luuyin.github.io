#!/usr/bin/env bash
#
# bin/deploy   â€•  Build site on SRC_BRANCH (default master) and
#                 forceâ€‘push static files to DEPLOY_BRANCH (default main).
#                 Requires ImageMagick (convert) installed locally.

###############################################################################
# å‚æ•°è§£æ
###############################################################################

SRC_BRANCH="master"
DEPLOY_BRANCH="main"
NO_PUSH=""
USAGE="usage: deploy [-h|--help] [-u|--user] [-s|--src SRC_BRANCH] \
[-d|--deploy DEPLOY_BRANCH] [--verbose] [--no-push]"

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)   echo "$USAGE"; exit 0 ;;
    -u|--user)   SRC_BRANCH="source"; DEPLOY_BRANCH="master" ;;
    -s|--src)    SRC_BRANCH="$2"; shift ;;
    -d|--deploy) DEPLOY_BRANCH="$2"; shift ;;
    --verbose)   set -x ;;
    --no-push)   NO_PUSH="--no-push" ;;
    *)           echo "Unknown option $1"; echo "$USAGE"; exit 1 ;;
  esac
  shift
done

set -e  # å­å‘½ä»¤å‡ºé”™å³é€€å‡º

###############################################################################
# å‰ç½®æ£€æŸ¥
###############################################################################

# 1) å·¥ä½œåŒºå¿…é¡»å¹²å‡€
if ! git diff-index --quiet HEAD --; then
  echo "â›” å°šæœ‰æœªæäº¤ä¿®æ”¹ï¼Œè¯·å…ˆ commitã€‚"; exit 1
fi
if [[ -n "$(git ls-files --exclude-standard --others)" ]]; then
  echo "â›” å°šæœ‰æœªè·Ÿè¸ªæ–‡ä»¶ï¼Œè¯·å…ˆ commit æˆ– stashï¼š" ; \
  git ls-files --exclude-standard --others ; exit 1
fi

# 2) å¿…é¡»å®‰è£… ImageMagickï¼ˆconvertï¼‰
if ! command -v convert >/dev/null 2>&1; then
  echo "â›” æœªæ£€æµ‹åˆ° ImageMagickï¼ˆconvertï¼‰ã€‚è¯·å…ˆå®‰è£…ï¼š"
  echo "   sudo apt-get install -y imagemagick webp"
  exit 1
fi

###############################################################################
# åˆ‡æ¢åˆ†æ”¯ & æ„å»º
###############################################################################

echo "ğŸš€ Deployingï¼š$SRC_BRANCH  â†’  $DEPLOY_BRANCH"

git checkout -B "$SRC_BRANCH"

git branch -D "$DEPLOY_BRANCH" 2>/dev/null || true
git checkout -b "$DEPLOY_BRANCH"

export JEKYLL_ENV=production
bundle exec jekyll build

###############################################################################
# æ¸…ç†æ—§æ–‡ä»¶å¹¶ç§»åŠ¨ _site
###############################################################################

find . -maxdepth 1 ! -name '.' \
                   ! -name '_site' \
                   ! -name '.git' \
                   ! -name 'CNAME' \
                   ! -name '.gitignore' \
                   ! -name '.gitattributes' \
                   ! -name '.nojekyll' \
                   -exec rm -rf {} +

mv _site/* .
rm -rf _site/

# é˜»æ­¢ GitHub Pages å†è·‘ Jekyll
touch .nojekyll

# å¯é€‰ï¼šç¡®ä¿ WebP æœ‰æ­£ç¡® MIME
if [[ ! -f .gitattributes ]]; then
  echo '*.webp binary' > .gitattributes
fi

###############################################################################
# æ¨é€
###############################################################################

git add -fA
git commit --allow-empty -m "Deploy $(date +'%F %T')" || true
[[ -z "$NO_PUSH" ]] && git push -f origin "$DEPLOY_BRANCH"

git checkout "$SRC_BRANCH"
echo "âœ…  Deploy å®Œæˆï¼"
