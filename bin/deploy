#!/usr/bin/env bash
#
# bin/deploy   ―  Build site on SRC_BRANCH (default master) and
#                 force‑push static files to DEPLOY_BRANCH (default main).
#                 Requires ImageMagick (convert) installed locally.

###############################################################################
# 参数解析
###############################################################################

SRC_BRANCH="master"
DEPLOY_BRANCH="main"
NO_PUSH=""
USAGE="usage: deploy [-h|--help] [-u|--user] [-s|--src SRC_BRANCH] \
[-d|--deploy DEPLOY_BRANCH] [--verbose] [--no-push]"

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)   echo "$USAGE"; exit 0 ;;
    -u|--user)   SRC_BRANCH="source"; DEPLOY_BRANCH="master" ;;
    -s|--src)    SRC_BRANCH="$2"; shift ;;
    -d|--deploy) DEPLOY_BRANCH="$2"; shift ;;
    --verbose)   set -x ;;
    --no-push)   NO_PUSH="--no-push" ;;
    *)           echo "Unknown option $1"; echo "$USAGE"; exit 1 ;;
  esac
  shift
done

set -e  # 子命令出错即退出

###############################################################################
# 前置检查
###############################################################################

# 1) 工作区必须干净
if ! git diff-index --quiet HEAD --; then
  echo "⛔ 尚有未提交修改，请先 commit。"; exit 1
fi
if [[ -n "$(git ls-files --exclude-standard --others)" ]]; then
  echo "⛔ 尚有未跟踪文件，请先 commit 或 stash：" ; \
  git ls-files --exclude-standard --others ; exit 1
fi

# 2) 必须安装 ImageMagick（convert）
if ! command -v convert >/dev/null 2>&1; then
  echo "⛔ 未检测到 ImageMagick（convert）。请先安装："
  echo "   sudo apt-get install -y imagemagick webp"
  exit 1
fi

###############################################################################
# 切换分支 & 构建
###############################################################################

echo "🚀 Deploying：$SRC_BRANCH  →  $DEPLOY_BRANCH"

git checkout -B "$SRC_BRANCH"

git branch -D "$DEPLOY_BRANCH" 2>/dev/null || true
git checkout -b "$DEPLOY_BRANCH"

export JEKYLL_ENV=production
bundle exec jekyll build

###############################################################################
# 清理旧文件并移动 _site
###############################################################################

find . -maxdepth 1 ! -name '.' \
                   ! -name '_site' \
                   ! -name '.git' \
                   ! -name 'CNAME' \
                   ! -name '.gitignore' \
                   ! -name '.gitattributes' \
                   ! -name '.nojekyll' \
                   -exec rm -rf {} +

mv _site/* .
rm -rf _site/

# 阻止 GitHub Pages 再跑 Jekyll
touch .nojekyll

# 可选：确保 WebP 有正确 MIME
if [[ ! -f .gitattributes ]]; then
  echo '*.webp binary' > .gitattributes
fi

###############################################################################
# 推送
###############################################################################

git add -fA
git commit --allow-empty -m "Deploy $(date +'%F %T')" || true
[[ -z "$NO_PUSH" ]] && git push -f origin "$DEPLOY_BRANCH"

git checkout "$SRC_BRANCH"
echo "✅  Deploy 完成！"
