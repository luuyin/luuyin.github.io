#!/usr/bin/env bash
set -Eeuo pipefail

# ä½¿ç”¨æ–¹æ³•ï¼š
#   bin/deploy -d main             # ä»â€œå½“å‰åˆ†æ”¯çš„ HEADâ€æ„å»ºï¼Œç„¶åå‘å¸ƒåˆ° main åˆ†æ”¯
#   bin/deploy -d gh-pages         # æˆ–å‘å¸ƒåˆ° gh-pages
DEPLOY_BRANCH="main"

while [[ $# -gt 0 ]]; do
  case "$1" in
    -d|--deploy) DEPLOY_BRANCH="$2"; shift ;;
    --verbose)   set -x ;;
    -h|--help)   echo "usage: bin/deploy [-d|--deploy DEPLOY_BRANCH]"; exit 0 ;;
    *)           echo "Unknown option $1"; exit 1 ;;
  esac
  shift
done

# 1) ä¿è¯å·¥ä½œåŒºå¹²å‡€
if ! git diff-index --quiet HEAD --; then
  echo "â›” å°šæœ‰æœªæäº¤ä¿®æ”¹ï¼Œè¯·å…ˆ commitã€‚"; exit 1
fi
if [[ -n "$(git ls-files --exclude-standard --others)" ]]; then
  echo "â›” å°šæœ‰æœªè·Ÿè¸ªæ–‡ä»¶ï¼Œè¯·å…ˆ commit æˆ–æ¸…ç†ï¼š"
  git ls-files --exclude-standard --others
  exit 1
fi

# 2) ç”¨å½“å‰åˆ†æ”¯çš„ HEAD ä½œä¸ºæ„å»ºæºç ï¼ˆä¸ä¼šåˆ‡æ¢åˆ†æ”¯ï¼‰
SRC_REF="$(git rev-parse --verify HEAD)"
echo "ğŸš€ Build from: $(git rev-parse --abbrev-ref HEAD) @ $SRC_REF"
echo "ğŸš€ Deploy to  : $DEPLOY_BRANCH"

# 3) æ„å»ºåˆ°ä¸´æ—¶ç›®å½•
BUILD_DIR="$(mktemp -d)"
export JEKYLL_ENV=production
bundle exec jekyll build --source . --destination "$BUILD_DIR"

# 4) ç”¨ worktree æ£€å‡ºéƒ¨ç½²åˆ†æ”¯åˆ°ä¸´æ—¶ç›®å½•
PUB_DIR="$(mktemp -d)"
# å¦‚æœè¿œç«¯å·²æœ‰è¯¥åˆ†æ”¯ï¼Œç”¨è¿œç«¯ä½œä¸ºèµ·ç‚¹ï¼›å¦åˆ™æœ¬åœ°åˆ›å»ºä¸€ä¸ªæ–°çš„
if git ls-remote --exit-code --heads origin "$DEPLOY_BRANCH" >/dev/null 2>&1; then
  git worktree add -B "$DEPLOY_BRANCH" "$PUB_DIR" "origin/$DEPLOY_BRANCH"
else
  git worktree add -B "$DEPLOY_BRANCH" "$PUB_DIR"
fi

# 5) åŒæ­¥é™æ€æ–‡ä»¶åˆ°éƒ¨ç½²åˆ†æ”¯ï¼ˆåˆ é™¤å¤šä½™æ–‡ä»¶ï¼‰
rsync -a --delete --exclude '.git' "$BUILD_DIR"/ "$PUB_DIR"/

# 6) é˜»æ­¢ Pages å†è·‘ Jekyll
touch "$PUB_DIR/.nojekyll"

# 7) æäº¤å¹¶æ¨é€
pushd "$PUB_DIR" >/dev/null
git add -A
git commit -m "Deploy $(date +'%F %T')" || true
git push origin "$DEPLOY_BRANCH"
popd >/dev/null

# 8) æ¸…ç†
git worktree remove "$PUB_DIR" --force
rm -rf "$BUILD_DIR"

echo "âœ… Done."
